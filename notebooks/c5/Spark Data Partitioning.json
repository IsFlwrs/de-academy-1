{"paragraphs":[{"text":"%md\n# Spark Data Partitioning\n\nWelcome to the notebook with the exercises for the fifth session. You’re halfway on the path to obtain the Wizeline Certification for Big Data Engineering with Spark!\nIf you have any feedback about our courses, email us at academy@wizeline.com or use the Academy Slack channel.\n \nIn this notebook you will be doing four exercises aimed at:\n - Looking at the data distribution of the partitions stored in your cluster.\n - Use different partitioning approaches to understand which is the best approach.\n - Understand the impact of the partitioning on the I/O functions.\n","user":"anonymous","dateUpdated":"2018-08-27T16:50:40+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true},"colWidth":12,"editorMode":"ace/mode/markdown","editorHide":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h1>Spark Data Partitioning</h1>\n<p>Welcome to the notebook with the exercises for the fifth session. You’re halfway on the path to obtain the Wizeline Certification for Big Data Engineering with Spark!<br/>If you have any feedback about our courses, email us at <a href=\"mailto:&#97;c&#97;&#x64;&#x65;&#x6d;&#x79;&#64;&#x77;&#x69;z&#101;&#x6c;&#105;n&#101;&#46;&#99;o&#109;\">&#97;c&#97;&#x64;&#x65;&#x6d;&#x79;&#64;&#x77;&#x69;z&#101;&#x6c;&#105;n&#101;&#46;&#99;o&#109;</a> or use the Academy Slack channel.</p>\n<p>In this notebook you will be doing four exercises aimed at:<br/> - Looking at the data distribution of the partitions stored in your cluster.<br/> - Use different partitioning approaches to understand which is the best approach.<br/> - Understand the impact of the partitioning on the I/O functions.</p>\n</div>"}]},"apps":[],"jobName":"paragraph_1535388578861_-1477887151","id":"20180824-154704_999864938","dateCreated":"2018-08-27T16:49:38+0000","dateStarted":"2018-08-27T16:50:40+0000","dateFinished":"2018-08-27T16:50:41+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:305"},{"title":"","text":"%md\n# Exercise 1- Partitions and data distribution\n\nIn this exercise, you will look at the the data contained in different partitions. Pay attention to how the data is distributed between the partitions depending on how they are created.\n\nYou are expected to use the DataSet sample `transactions`, which contains monetary transactions for users in the world.\n","user":"anonymous","dateUpdated":"2018-08-27T16:51:05+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true},"colWidth":12,"editorMode":"ace/mode/markdown","editorHide":true,"title":false,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h1>Exercise 1- Partitions and data distribution</h1>\n<p>In this exercise, you will look at the the data contained in different partitions. Pay attention to how the data is distributed between the partitions depending on how they are created.</p>\n<p>You are expected to use the DataSet sample <code>transactions</code>, which contains monetary transactions for users in the world.</p>\n</div>"}]},"apps":[],"jobName":"paragraph_1535388578870_-1467498930","id":"20180824-160322_654860629","dateCreated":"2018-08-27T16:49:38+0000","dateStarted":"2018-08-27T16:51:05+0000","dateFinished":"2018-08-27T16:51:05+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:306"},{"text":"%pyspark\n\nTransactionSchema = ['name', 'amount', 'country']\n\ntransactions = [\n    ('Bob', 100, 'United Kingdom'),\n    ('James', 15, 'United Kingdom'),\n    ('Marek', 51, 'Poland'),\n    ('Johannes', 200, 'Germany'),\n    ('Paul', 75, 'Poland'),\n    ('Bob', 35, 'Mexico'),\n    ('James', 21, 'Germany')\n]\n\n","user":"anonymous","dateUpdated":"2018-08-27T19:09:18+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python","editOnDblClick":false}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1535388578874_-1469037926","id":"20180824-160727_1105840180","dateCreated":"2018-08-27T16:49:38+0000","dateStarted":"2018-08-27T19:09:18+0000","dateFinished":"2018-08-27T19:09:18+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:307"},{"text":"case class Transactions(name:String, amount:Long, country:String)\n\nval transactions = List(\n    Transactions(\"Bob\", 25, \"MX\"),\n    Transactions(\"James\", 15, \"United Kingdom\"),\n    Transactions(\"Marek\", 51, \"Poland\"),\n    Transactions(\"Johannes\", 200,\"Germany\"),\n    Transactions(\"Paul\", 75, \"Poland\"),\n    Transactions(\"Bob\", 35, \"Mexico\"),\n    Transactions(\"James\", 21, \"Germany\")\n)","user":"anonymous","dateUpdated":"2018-08-27T19:11:15+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala"},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"defined class Transactions\ntransactions: List[Transactions] = List(Transactions(Bob,25,MX), Transactions(James,15,United Kingdom), Transactions(Marek,51,Poland), Transactions(Johannes,200,Germany), Transactions(Paul,75,Poland), Transactions(Bob,35,Mexico), Transactions(James,21,Germany))\n"}]},"apps":[],"jobName":"paragraph_1535390611007_-536126944","id":"20180827-172331_1658203493","dateCreated":"2018-08-27T17:23:31+0000","dateStarted":"2018-08-27T19:11:15+0000","dateFinished":"2018-08-27T19:11:15+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:308"},{"text":"%md\n\nThe following code snippet creates a data frame and outputs you the number of partitions, partitioner and partition structure.\n","dateUpdated":"2018-08-27T16:49:38+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true},"colWidth":12,"editorMode":"ace/mode/markdown","editorHide":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<p>The following code snippet creates a data frame and outputs you the number of partitions, partitioner and partition structure.</p>\n</div>"}]},"apps":[],"jobName":"paragraph_1535388578874_-1469037926","id":"20180824-161222_1775895785","dateCreated":"2018-08-27T16:49:38+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:309"},{"text":"%pyspark\nfrom pyspark.sql import SparkSession, Row\n    \ndf = spark.createDataFrame(transactions, TransactionSchema)\n\nprint(\"Number of partitions: {}\".format(df.rdd.getNumPartitions()))\nprint(\"Partitioner: {}\".format(df.rdd.partitioner))\nprint(\"Partitions structure: {}\".format(df.rdd.glom().collect()))","user":"anonymous","dateUpdated":"2018-08-27T19:11:21+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"Number of partitions: 3\nPartitioner: None\nPartitions structure: [[Row(name=u'Bob', amount=100, country=u'United Kingdom'), Row(name=u'James', amount=15, country=u'United Kingdom')], [Row(name=u'Marek', amount=51, country=u'Poland'), Row(name=u'Johannes', amount=200, country=u'Germany')], [Row(name=u'Paul', amount=75, country=u'Poland'), Row(name=u'Bob', amount=35, country=u'Mexico'), Row(name=u'James', amount=21, country=u'Germany')]]\n"}]},"apps":[],"jobName":"paragraph_1535388578875_-1469422675","id":"20180824-161021_1826354548","dateCreated":"2018-08-27T16:49:38+0000","dateStarted":"2018-08-27T19:11:21+0000","dateFinished":"2018-08-27T19:11:21+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:310"},{"text":"import org.apache.spark.sql.Row\n\n\nval df = spark.createDataFrame(transactions)\n\ndf.rdd.getNumPartitions\ndf.rdd.partitioner\ndf.rdd.glom().collect()\n","user":"anonymous","dateUpdated":"2018-08-27T19:12:09+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala"},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"import org.apache.spark.sql.Row\ndf: org.apache.spark.sql.DataFrame = [name: string, amount: bigint ... 1 more field]\nres79: Int = 3\nres80: Option[org.apache.spark.Partitioner] = None\nres81: Array[Array[org.apache.spark.sql.Row]] = Array(Array([Bob,25,MX], [James,15,United Kingdom]), Array([Marek,51,Poland], [Johannes,200,Germany]), Array([Paul,75,Poland], [Bob,35,Mexico], [James,21,Germany]))\n"}]},"apps":[],"jobName":"paragraph_1535394153903_767887769","id":"20180827-182233_1620123781","dateCreated":"2018-08-27T18:22:33+0000","dateStarted":"2018-08-27T19:12:09+0000","dateFinished":"2018-08-27T19:12:10+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:311"},{"text":"%md\nLook at the output and answer the following questions:\n    - Names on partition 1\n    - Amounts on partition 2\n    - Why is the partitioned `None`?\n\n","dateUpdated":"2018-08-27T16:49:38+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true},"colWidth":12,"editorMode":"ace/mode/markdown","editorHide":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<p>Look at the output and answer the following questions:<br/> - Names on partition 1<br/> - Amounts on partition 2<br/> - Why is the partitioned <code>None</code>?</p>\n</div>"}]},"apps":[],"jobName":"paragraph_1535388578876_-1471346419","id":"20180824-161209_564012877","dateCreated":"2018-08-27T16:49:38+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:312"},{"text":"%md\n**REPARTITIONING:** The following code repartitions the original DataFrame and outputs the same information. ","dateUpdated":"2018-08-27T16:49:38+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true},"colWidth":12,"editorMode":"ace/mode/markdown","editorHide":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<p><strong>REPARTITIONING:</strong> The following code repartitions the original DataFrame and outputs the same information.</p>\n</div>"}]},"apps":[],"jobName":"paragraph_1535388578877_-1470576922","id":"20180824-161118_605198725","dateCreated":"2018-08-27T16:49:38+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:313"},{"text":"%pyspark\ndf2 = df.repartition(\"country\")\n    \nprint(\"\\nAfter 'repartition()'\")\nprint(\"Number of partitions: {}\".format(df2.rdd.getNumPartitions()))\nprint(\"Partitioner: {}\".format(df2.rdd.partitioner))\nprint(\"Partitions structure: {}\".format(df2.rdd.glom().collect()))","user":"anonymous","dateUpdated":"2018-08-27T19:12:15+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python","editOnDblClick":false}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"\nAfter 'repartition()'\nNumber of partitions: 200\nPartitioner: None\nPartitions structure: [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [Row(name=u'James', amount=21, country=u'Germany'), Row(name=u'Johannes', amount=200, country=u'Germany')], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [Row(name=u'Bob', amount=35, country=u'Mexico')], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [Row(name=u'Paul', amount=75, country=u'Poland'), Row(name=u'Marek', amount=51, country=u'Poland')], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [Row(name=u'Bob', amount=100, country=u'United Kingdom'), Row(name=u'James', amount=15, country=u'United Kingdom')], [], [], [], []]\n"}]},"apps":[],"jobName":"paragraph_1535388578878_-1470576922","id":"20180824-161919_1765365187","dateCreated":"2018-08-27T16:49:38+0000","dateStarted":"2018-08-27T19:12:15+0000","dateFinished":"2018-08-27T19:12:19+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:314"},{"text":"val df2 = df.repartition($\"country\")\n\ndf2.rdd.getNumPartitions\ndf2.rdd.partitioner\ndf2.rdd.glom().collect()","user":"anonymous","dateUpdated":"2018-08-27T19:21:39+0000","config":{"colWidth":12,"enabled":true,"results":{"0":{"graph":{"mode":"table","height":125,"optionOpen":false}}},"editorSetting":{"language":"scala"},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"df2: org.apache.spark.sql.Dataset[org.apache.spark.sql.Row] = [name: string, amount: bigint ... 1 more field]\nres159: Int = 200\nres160: Option[org.apache.spark.Partitioner] = None\nres161: Array[Array[org.apache.spark.sql.Row]] = Array(Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array([Bob,25,MX]), Array(), Array(), Array(), Array(), Array([Johannes,200,Germany], [James,21,Germany]), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array..."}]},"apps":[],"jobName":"paragraph_1535397099772_1077363205","id":"20180827-191139_22040351","dateCreated":"2018-08-27T19:11:39+0000","dateStarted":"2018-08-27T19:21:39+0000","dateFinished":"2018-08-27T19:21:39+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:315"},{"text":"%md\nLook at the output and answer the following questions:\n - Amounts on partition 1\n - Names on partition 2\n - What is the main difference?\n","dateUpdated":"2018-08-27T16:49:38+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true},"colWidth":12,"editorMode":"ace/mode/markdown","editorHide":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<p>Look at the output and answer the following questions:<br/> - Amounts on partition 1<br/> - Names on partition 2<br/> - What is the main difference?</p>\n</div>"}]},"apps":[],"jobName":"paragraph_1535388578879_-1470961671","id":"20180824-161944_2121074393","dateCreated":"2018-08-27T16:49:38+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:316"},{"text":"%md\nRemember more partitions != uniform partition distribution. So more partitions is not necessarily the answer, in fact if you end up having too many partitions you may bump into a problem with very small files.","dateUpdated":"2018-08-27T16:49:38+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true},"colWidth":12,"editorMode":"ace/mode/markdown","editorHide":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<p>Remember more partitions != uniform partition distribution. So more partitions is not necessarily the answer, in fact if you end up having too many partitions you may bump into a problem with very small files.</p>\n</div>"}]},"apps":[],"jobName":"paragraph_1535388578881_-1485582129","id":"20180824-163234_318434487","dateCreated":"2018-08-27T16:49:38+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:317"},{"text":"%md\n# Exercise 2 - Partitioning approaches\n\nUsing the same dataset, create new datasets, try partitioning using each one of the columns. This means you will end with 4 distinct datasets.\n","dateUpdated":"2018-08-27T16:49:38+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true},"colWidth":12,"editorMode":"ace/mode/markdown","editorHide":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h1>Exercise 2 - Partitioning approaches</h1>\n<p>Using the same dataset, create new datasets, try partitioning using each one of the columns. This means you will end with 4 distinct datasets.</p>\n</div>"}]},"apps":[],"jobName":"paragraph_1535388578883_-1484812631","id":"20180824-163253_580541449","dateCreated":"2018-08-27T16:49:38+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:318"},{"text":"%pyspark\ndf2 = df.repartition(\"name\")\n    \nprint(\"\\nAfter 'repartition()' with column 'name'\")\nprint(\"Number of partitions: {}\".format(df2.rdd.getNumPartitions()))\nprint(\"Partitioner: {}\".format(df2.rdd.partitioner))\nprint(\"Partitions structure: {}\".format(df2.rdd.glom().collect()))\n","user":"anonymous","dateUpdated":"2018-08-27T16:52:37+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python","editOnDblClick":false}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"\nAfter 'repartition()' with column 'name'\nNumber of partitions: 200\nPartitioner: None\nPartitions structure: [[], [], [], [], [], [], [], [], [], [], [], [], [Row(amount=15, country=u'United Kingdom', name=u'James'), Row(amount=21, country=u'Germany', name=u'James')], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [Row(amount=100, country=u'United Kingdom', name=u'Bob'), Row(amount=35, country=u'Mexico', name=u'Bob')], [], [], [Row(amount=51, country=u'Poland', name=u'Marek')], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [Row(amount=200, country=u'Germany', name=u'Johannes')], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [Row(amount=75, country=u'Poland', name=u'Paul')], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], []]\n"}]},"apps":[],"jobName":"paragraph_1535388578883_-1484812631","id":"20180824-163321_450981945","dateCreated":"2018-08-27T16:49:38+0000","dateStarted":"2018-08-27T16:52:37+0000","dateFinished":"2018-08-27T16:52:42+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:319"},{"text":"val df2 = df.repartition($\"name\")\n\ndf2.rdd.getNumPartitions\ndf2.rdd.partitioner\ndf2.rdd.glom().collect()\n","user":"anonymous","dateUpdated":"2018-08-27T19:22:29+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala"},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"df2: org.apache.spark.sql.Dataset[org.apache.spark.sql.Row] = [name: string, amount: bigint ... 1 more field]\nres163: Int = 200\nres164: Option[org.apache.spark.Partitioner] = None\nres165: Array[Array[org.apache.spark.sql.Row]] = Array(Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array([James,15,United Kingdom], [James,21,Germany]), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Array(), Arra..."}]},"apps":[],"jobName":"paragraph_1535397729481_-774115256","id":"20180827-192209_233833264","dateCreated":"2018-08-27T19:22:09+0000","dateStarted":"2018-08-27T19:22:29+0000","dateFinished":"2018-08-27T19:22:30+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:320"},{"text":"%md\nAfter printing the number of partitions, partitioner and partitions structure, answer the following question: \n - In this case, what is the best approach?\n - How can you determine that?\n","dateUpdated":"2018-08-27T16:49:38+0000","config":{"colWidth":12,"editorMode":"ace/mode/markdown","results":{},"enabled":true,"editorSetting":{"language":"markdown","editOnDblClick":true}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<p>After printing the number of partitions, partitioner and partitions structure, answer the following question:<br/> - In this case, what is the best approach?<br/> - How can you determine that?</p>\n</div>"}]},"apps":[],"jobName":"paragraph_1535388578884_-1486736375","id":"20180824-163507_1092132855","dateCreated":"2018-08-27T16:49:38+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:321"},{"text":"%md\nAs you can see, the repartitioning has a direct effect on the distribution of the information, using the correct column is essential. For knowing the most appropriate column, you need to be familiar with the data, there is no workaround. ","dateUpdated":"2018-08-27T16:49:38+0000","config":{"colWidth":12,"editorMode":"ace/mode/markdown","results":{},"enabled":true,"editorSetting":{"language":"markdown","editOnDblClick":true}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<p>As you can see, the repartitioning has a direct effect on the distribution of the information, using the correct column is essential. For knowing the most appropriate column, you need to be familiar with the data, there is no workaround.</p>\n</div>"}]},"apps":[],"jobName":"paragraph_1535388578884_-1486736375","id":"20180824-163550_767573207","dateCreated":"2018-08-27T16:49:38+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:322"},{"text":"%md\n# Exercise 3 - I/O with single and multiple files\n\nNow, look at reading and writing. You already know this is a costly operation. Regardless, there are strategies for troubleshooting or improving the reading and writing performance. This exercise requires you to Read and Write a DataSet in a single file and multiple files to compare performance.\n\nQuestion: How do you determine the best approach?\nNote: unless you control what is being written, you can only make recommendations on the file sizes for you to read later. If you are given one big block then your fate is sealed.\n","user":"anonymous","dateUpdated":"2018-08-27T16:59:33+0000","config":{"colWidth":12,"editorMode":"ace/mode/markdown","results":{},"enabled":true,"editorSetting":{"language":"markdown","editOnDblClick":true},"editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h1>Exercise 3 - I/O with single and multiple files</h1>\n<p>Now, look at reading and writing. You already know this is a costly operation. Regardless, there are strategies for troubleshooting or improving the reading and writing performance. This exercise requires you to Read and Write a DataSet in a single file and multiple files to compare performance.</p>\n<p>Question: How do you determine the best approach?<br/>Note: unless you control what is being written, you can only make recommendations on the file sizes for you to read later. If you are given one big block then your fate is sealed.</p>\n</div>"}]},"apps":[],"jobName":"paragraph_1535388578884_-1486736375","id":"20180824-163615_1064210426","dateCreated":"2018-08-27T16:49:38+0000","dateStarted":"2018-08-27T16:59:33+0000","dateFinished":"2018-08-27T16:59:33+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:323"},{"text":"%md First let's read the data. The dataset is quite big, so let's take a small sample instead:","user":"anonymous","dateUpdated":"2018-08-27T19:24:39+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"markdown","editOnDblClick":true},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<p>First let&rsquo;s read the data. The dataset is quite big, so let&rsquo;s take a small sample instead:</p>\n</div>"}]},"apps":[],"jobName":"paragraph_1535389183937_-1024181710","id":"20180827-165943_350742125","dateCreated":"2018-08-27T16:59:43+0000","dateStarted":"2018-08-27T19:24:39+0000","dateFinished":"2018-08-27T19:24:39+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:324"},{"text":"%pyspark\ndf = spark.read.json(\"gs://de-training-input/alimazon/50000/client-orders/*.gz\") \\\n    .sample(False, 0.2)  # take 20% of the data without replacement\ndf.count()","user":"anonymous","dateUpdated":"2018-08-27T19:40:56+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"13147\n"}]},"apps":[],"jobName":"paragraph_1535390845078_-1877809300","id":"20180827-172725_2084099563","dateCreated":"2018-08-27T17:27:25+0000","dateStarted":"2018-08-27T19:40:56+0000","dateFinished":"2018-08-27T19:41:00+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:325"},{"text":"val df = spark.read.json(\"gs://de-training-input/alimazon/50000/client-orders/*.gz\")\n    .sample(false, 0.2) // take 20% of the data without replacement\ndf.count()","user":"anonymous","dateUpdated":"2018-08-27T19:41:07+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala"},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"df: org.apache.spark.sql.Dataset[org.apache.spark.sql.Row] = [client_id: string, id: string ... 4 more fields]\nres166: Long = 13356\n"}]},"apps":[],"jobName":"paragraph_1535389248262_-1065875797","id":"20180827-170048_1570856632","dateCreated":"2018-08-27T17:00:48+0000","dateStarted":"2018-08-27T19:41:07+0000","dateFinished":"2018-08-27T19:41:11+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:326"},{"text":"%md **`NOTE:`** Do not forget to set you username here","user":"anonymous","dateUpdated":"2018-08-27T17:16:37+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"markdown","editOnDblClick":true},"editorMode":"ace/mode/markdown"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<p><strong><code>NOTE:</code></strong> Do not forget to set you username here</p>\n</div>"}]},"apps":[],"jobName":"paragraph_1535390004014_-1924959916","id":"20180827-171324_1624649057","dateCreated":"2018-08-27T17:13:24+0000","dateStarted":"2018-08-27T17:16:37+0000","dateFinished":"2018-08-27T17:16:37+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:327"},{"text":"%pyspark\nusername = \"<user-name>\"","user":"anonymous","dateUpdated":"2018-08-27T17:36:45+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python"},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1535391360819_610308763","id":"20180827-173600_941913882","dateCreated":"2018-08-27T17:36:00+0000","dateStarted":"2018-08-27T17:36:45+0000","dateFinished":"2018-08-27T17:36:45+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:328"},{"text":"val username = \"<user-name>\"","user":"anonymous","dateUpdated":"2018-08-27T17:17:03+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala"},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"username: String = <user-name>\n"}]},"apps":[],"jobName":"paragraph_1535390200285_944236870","id":"20180827-171640_353868380","dateCreated":"2018-08-27T17:16:40+0000","dateStarted":"2018-08-27T17:17:03+0000","dateFinished":"2018-08-27T17:17:03+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:329"},{"text":"%md Let's write our data using different partitions.\nConfirm in GCP that the dataset was written in the number of specified partitions.","user":"anonymous","dateUpdated":"2018-08-27T19:27:41+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"markdown","editOnDblClick":true},"editorMode":"ace/mode/markdown"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<p>Let&rsquo;s write our data using different partitions.<br/>Check in GCP the number of files on each bucket.</p>\n</div>"}]},"apps":[],"jobName":"paragraph_1535389249481_-1437927984","id":"20180827-170049_2139323805","dateCreated":"2018-08-27T17:00:49+0000","dateStarted":"2018-08-27T17:01:48+0000","dateFinished":"2018-08-27T17:01:48+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:330"},{"text":"%pyspark\ndf.repartition(1).write.json(for\"gs://de-training-output-$username/client-orders-1part/\")\ndf.repartition(6).write.json(s\"gs://de-training-output-$username/client-orders-6part/\")\n","user":"anonymous","dateUpdated":"2018-08-27T17:37:04+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1535391386408_-192815434","id":"20180827-173626_223417974","dateCreated":"2018-08-27T17:36:26+0000","status":"READY","progressUpdateIntervalMs":500,"$$hashKey":"object:331"},{"text":"df.repartition(1).write.json(\"gs://de-training-output-{}/client-orders-1part/\".format(username))\ndf.repartition(6).write.json(\"gs://de-training-output-{}/client-orders-6part/\".format(username))","user":"anonymous","dateUpdated":"2018-08-27T17:39:04+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala"},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"results":{"code":"ERROR","msg":[{"type":"TEXT","data":"<console>:28: error: not found: value df\n       df.repartition(1).write.json(s\"gs://de-training-output-{}/client-orders-1part/\".format(username))\n       ^\n"}]},"apps":[],"jobName":"paragraph_1535389921112_-159994641","id":"20180827-171201_1462543897","dateCreated":"2018-08-27T17:12:01+0000","dateStarted":"2018-08-27T17:38:07+0000","dateFinished":"2018-08-27T17:38:07+0000","status":"ERROR","progressUpdateIntervalMs":500,"$$hashKey":"object:332"},{"user":"anonymous","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"markdown","editOnDblClick":true},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1535398143325_-1907804988","id":"20180827-192903_1248488032","dateCreated":"2018-08-27T19:29:03+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:1773","text":"%md Let's experiment a bit more reading and writing using different numbers of partitions:","dateUpdated":"2018-08-27T19:29:19+0000","dateFinished":"2018-08-27T19:29:19+0000","dateStarted":"2018-08-27T19:29:19+0000","results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<p>Let&rsquo;s experiment a bit more reading and writing using different numbers of partitions:</p>\n</div>"}]}},{"text":"%md Here is the example for reading from one file and writing to one file","user":"anonymous","dateUpdated":"2018-08-27T19:29:14+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"text","editOnDblClick":false},"editorMode":"ace/mode/text","editorHide":false,"tableHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<p>%md Here is the example for reading from one file and writing to one file</p>\n</div>"}]},"apps":[],"jobName":"paragraph_1535390260069_-83199224","id":"20180827-171740_251328243","dateCreated":"2018-08-27T17:17:40+0000","dateStarted":"2018-08-27T19:29:10+0000","dateFinished":"2018-08-27T19:29:10+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:333"},{"text":"%pyspark\ndf1 = sqlContext.read.json(\"gs://de-training-output-{}/client-orders-1part/\".format(username))\ndf1.repartition(1).write.csv(\"gs://de-training-output-{}/client-orders-1in-1out/\".format(username))\n","user":"anonymous","dateUpdated":"2018-08-27T17:39:45+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1535391504478_-1921322031","id":"20180827-173824_1583828117","dateCreated":"2018-08-27T17:38:24+0000","status":"READY","progressUpdateIntervalMs":500,"$$hashKey":"object:334"},{"text":"val df1 = spark.read.json(s\"gs://de-training-output-$username/client-orders-1part/\")\ndf1.repartition(1).write.csv(s\"gs://de-training-output-$username/client-orders-1in-1out/\")","user":"anonymous","dateUpdated":"2018-08-27T17:19:03+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala"},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1535390300729_1268100210","id":"20180827-171820_27449283","dateCreated":"2018-08-27T17:18:20+0000","status":"READY","progressUpdateIntervalMs":500,"$$hashKey":"object:335"},{"text":"%md Here is the example for reading from multiple files and writing to multiple files","user":"anonymous","dateUpdated":"2018-08-27T17:19:34+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"markdown","editOnDblClick":true},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<p>Here is the example for reading from multiple files and writing to multiple files</p>\n</div>"}]},"apps":[],"jobName":"paragraph_1535390343211_549666745","id":"20180827-171903_233529514","dateCreated":"2018-08-27T17:19:03+0000","dateStarted":"2018-08-27T17:19:34+0000","dateFinished":"2018-08-27T17:19:34+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:336"},{"text":"%pyspark\ndf6 = sqlContext.read.json(\"gs://de-training-output-{}/client-orders-6part/\".format(username))\ndf6.repartition(6).write.csv(\"gs://de-training-output-{}/client-orders-6in-6out/\".format(username))","user":"anonymous","dateUpdated":"2018-08-27T17:41:31+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python"},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1535391663041_-730311292","id":"20180827-174103_2146116059","dateCreated":"2018-08-27T17:41:03+0000","status":"READY","progressUpdateIntervalMs":500,"$$hashKey":"object:337"},{"text":"val df6 = spark.read.json(s\"gs://de-training-output-$username/client-orders-6part/\")\ndf6.repartition(6).write.csv(s\"gs://de-training-output-$username/client-orders-6in-6out/\")","user":"anonymous","dateUpdated":"2018-08-27T17:21:22+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala"},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1535390446686_1446855207","id":"20180827-172046_737696731","dateCreated":"2018-08-27T17:20:46+0000","status":"READY","progressUpdateIntervalMs":500,"$$hashKey":"object:338"},{"text":"%md Explore using different number of partitions, reading from 1 file and writing to 4","user":"anonymous","dateUpdated":"2018-08-27T17:42:08+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"markdown","editOnDblClick":true},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<p>Explore using different number of partitions, reading from 1 file and writing to 4</p>\n</div>"}]},"apps":[],"jobName":"paragraph_1535390491052_1871895472","id":"20180827-172131_750013194","dateCreated":"2018-08-27T17:21:31+0000","dateStarted":"2018-08-27T17:42:08+0000","dateFinished":"2018-08-27T17:42:08+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:339"},{"text":"%md\n# Exercise 4 - Flights dataset partitions size\n\nThe next code help you to display the size of each partition, we are going to generate a sample dataset\n","dateUpdated":"2018-08-27T16:49:38+0000","config":{"colWidth":12,"editorMode":"ace/mode/markdown","results":{},"enabled":true,"editorSetting":{"language":"markdown","editOnDblClick":true}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h1>Exercise 4 - Flights dataset partitions size</h1>\n<p>The next code help you to display the size of each partition, we are going to generate a sample dataset</p>\n</div>"}]},"apps":[],"jobName":"paragraph_1535388578885_-1487121124","id":"20180824-163816_107227786","dateCreated":"2018-08-27T16:49:38+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:340"},{"text":"%pyspark\nfrom itertools import chain\n\nsample_dataset = spark.createDataFrame(chain([(i, 0) for i in range(1, 100001)], [(i, j) for i in range(1, 101) for j in range(1, 101)])).cache()\nprint(sample_dataset.rdd.getNumPartitions())\nprint(sample_dataset.rdd.mapPartitions(lambda part: (len(list(part)),)).take(3))","user":"anonymous","dateUpdated":"2018-08-27T18:19:17+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"3\n[36864, 36864, 36272]\n"}]},"apps":[],"jobName":"paragraph_1535391780082_656124530","id":"20180827-174300_1370563640","dateCreated":"2018-08-27T17:43:00+0000","dateStarted":"2018-08-27T18:19:17+0000","dateFinished":"2018-08-27T18:19:20+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:341"},{"text":"\nval sampleDataSet = ((1 to 100000).map((_,0))++(1 to 100).flatMap(i => (1 to 100).map((_,i)))).toDS.cache\n\nsampleDataSet.rdd.getNumPartitions\n\nsampleDataSet.mapPartitions(iter => Seq(iter.size).iterator).take(3)\n","user":"anonymous","dateUpdated":"2018-08-27T18:19:49+0000","config":{"colWidth":12,"editorMode":"ace/mode/scala","results":{},"enabled":true,"editorSetting":{"language":"scala","editOnDblClick":false}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"sampleDataSet: org.apache.spark.sql.Dataset[(Int, Int)] = [_1: int, _2: int]\nres11: Int = 3\nres13: Array[Int] = Array(36666, 36667, 36667)\n"}]},"apps":[],"jobName":"paragraph_1535388578885_-1487121124","id":"20180824-163856_1912329826","dateCreated":"2018-08-27T16:49:38+0000","dateStarted":"2018-08-27T18:19:49+0000","dateFinished":"2018-08-27T18:19:52+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:342"},{"text":"%md\nNow, using your acquired knowledge of former sessions, load the flights DataSet and display the size of the partitions\n","dateUpdated":"2018-08-27T16:53:35+0000","config":{"tableHide":true,"editorSetting":{"language":"markdown","editOnDblClick":true},"colWidth":12,"editorMode":"ace/mode/markdown","editorHide":false,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<p>Now, using your acquired knowledge of former sessions, load the flights DataSet and display the size of the partitions</p>\n</div>"}]},"apps":[],"jobName":"paragraph_1535388578885_-1487121124","id":"20180824-163919_2039405814","dateCreated":"2018-08-27T16:49:38+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:343"},{"text":"","dateUpdated":"2018-08-27T19:29:57+0000","config":{"colWidth":12,"editorMode":"ace/mode/scala","results":{},"enabled":true,"editorSetting":{"language":"scala","editOnDblClick":true}},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1535388578886_-1485966878","id":"20180824-163954_1813225578","dateCreated":"2018-08-27T16:49:38+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:344"}],"name":"Spark Data Partitioning","id":"2DPBZSVT9","angularObjects":{"2DPGAMRNT:shared_process":[],"2DQR1ZBND:shared_process":[],"2DN79T8NZ:shared_process":[],"2DQBWZ79F:shared_process":[],"2DPW1HRVC:shared_process":[],"2DRCEAGMX:shared_process":[],"2DQ61ZN5P:shared_process":[],"2DQJXACQY:shared_process":[],"2DPQRDXVU:shared_process":[],"2DP4AM3VR:shared_process":[],"2DN5AE5RK:shared_process":[],"2DPRYZ7VJ:shared_process":[],"2DNKQ5CVJ:shared_process":[],"2DQW84QS8:shared_process":[],"2DQW421Z6:shared_process":[],"2DNWYY4G9:shared_process":[],"2DQWMRTBT:shared_process":[],"2DNVZQ79F:shared_process":[]},"config":{"looknfeel":"default","personalizedMode":"false"},"info":{}}